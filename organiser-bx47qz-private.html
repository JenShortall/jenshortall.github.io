<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Organiser Overview</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --ink:#1a1a2e; --paper:#faf8f4; --cream:#f0ece3;
    --accent:#c9573a; --accent-light:#fde8e4;
    --gold:#d4a843; --sage:#6b8f71; --sage-light:#e8f0e9;
    --muted:#8a8070; --border:#ddd8cc;
    --wedding:#7b3fa0; --wedding-light:#f3eaf9;
  }
  * { box-sizing:border-box; margin:0; padding:0; }
  body { font-family:'DM Sans',sans-serif; background:var(--paper); color:var(--ink); min-height:100vh; }

  /* Setup instructions banner */
  .setup-banner {
    background:#1e3a5f; color:white; padding:1.5rem 2rem;
    font-size:0.85rem; line-height:1.8;
  }
  .setup-banner h2 { font-family:'Playfair Display',serif; font-size:1.1rem; margin-bottom:0.8rem; color:#f0d080; }
  .setup-banner ol { padding-left:1.3rem; }
  .setup-banner li { margin-bottom:0.4rem; }
  .setup-banner code { background:rgba(255,255,255,0.15); padding:0.1rem 0.4rem; border-radius:4px; font-size:0.82rem; }
  .setup-banner a { color:#7dd3fc; }
  .setup-banner .dismiss { display:inline-block; margin-top:1rem; background:rgba(255,255,255,0.15); border:none; color:white; padding:0.4rem 1rem; border-radius:6px; cursor:pointer; font-family:'DM Sans',sans-serif; font-size:0.82rem; }
  .setup-banner .dismiss:hover { background:rgba(255,255,255,0.25); }

  header { background:var(--ink); padding:2rem 2rem 1.6rem; text-align:center; position:relative; overflow:hidden; }
  header::before { content:''; position:absolute; inset:0; background:repeating-linear-gradient(45deg,transparent,transparent 20px,rgba(255,255,255,0.018) 20px,rgba(255,255,255,0.018) 21px); }
  header::after { content:'â™© â™ª â™« â™¬ â™© â™ª â™« â™¬ â™© â™ª â™« â™¬'; position:absolute; bottom:0.3rem; left:0; right:0; text-align:center; font-size:1rem; color:rgba(255,255,255,0.055); letter-spacing:0.5rem; pointer-events:none; }
  header h1 { font-family:'Playfair Display',serif; font-size:clamp(1.5rem,4vw,2.4rem); color:var(--paper); font-weight:900; letter-spacing:-0.02em; position:relative; }
  header p { color:rgba(255,255,255,0.48); margin-top:0.3rem; font-size:0.88rem; font-weight:300; position:relative; }
  .organiser-badge { display:inline-flex; align-items:center; gap:0.4rem; background:var(--gold); color:#3a2a00; border-radius:20px; padding:0.3rem 1rem; font-size:0.82rem; font-weight:700; margin-top:0.7rem; position:relative; }

  .page { padding:1.4rem; max-width:900px; margin:0 auto; }

  .top-bar { display:flex; align-items:center; gap:0.8rem; margin-bottom:1.1rem; flex-wrap:wrap; }
  .refresh-btn { display:flex; align-items:center; gap:0.4rem; background:var(--cream); border:1.5px solid var(--border); border-radius:8px; padding:0.4rem 0.9rem; font-family:'DM Sans',sans-serif; font-size:0.82rem; font-weight:500; color:var(--muted); cursor:pointer; transition:all 0.15s; }
  .refresh-btn:hover { border-color:var(--sage); color:var(--sage); }
  .last-updated { font-size:0.78rem; color:var(--muted); font-style:italic; }

  .overview-header { background:white; border:1.5px solid var(--border); border-radius:12px; padding:1.3rem; margin-bottom:1.1rem; }
  .overview-header h2 { font-family:'Playfair Display',serif; font-size:1.1rem; margin-bottom:0.8rem; }
  .singers-list { display:flex; flex-wrap:wrap; gap:0.4rem; }
  .singer-chip { display:flex; align-items:center; gap:0.35rem; background:var(--cream); border:1px solid var(--border); border-radius:20px; padding:0.22rem 0.65rem 0.22rem 0.45rem; font-size:0.82rem; }
  .chip-dot { width:6px; height:6px; border-radius:50%; background:var(--sage); }
  .chip-remove { cursor:pointer; color:var(--muted); margin-left:0.15rem; font-size:0.88rem; }
  .chip-remove:hover { color:var(--accent); }
  .no-singers { color:var(--muted); font-size:0.86rem; font-style:italic; }

  .legend { display:flex; gap:1rem; flex-wrap:wrap; margin-bottom:0.9rem; font-size:0.78rem; color:var(--muted); align-items:center; }
  .legend-item { display:flex; align-items:center; gap:0.3rem; }
  .legend-swatch { width:13px; height:6px; border-radius:3px; }
  .sw-great{background:var(--sage);} .sw-ok{background:var(--gold);} .sw-low{background:var(--accent);}

  .week-nav { display:flex; align-items:center; gap:0.6rem; margin-bottom:1rem; flex-wrap:wrap; }
  .week-pills { display:flex; gap:0.4rem; flex-wrap:wrap; }
  .week-pill { padding:0.35rem 0.9rem; border-radius:20px; border:1.5px solid var(--border); background:white; font-size:0.8rem; font-weight:500; color:var(--muted); cursor:pointer; transition:all 0.15s; white-space:nowrap; }
  .week-pill:hover { border-color:var(--accent); color:var(--ink); }
  .week-pill.active { background:var(--accent); border-color:var(--accent); color:white; font-weight:600; }
  .week-arrow { width:32px; height:32px; border-radius:50%; border:1.5px solid var(--border); background:white; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:1rem; color:var(--muted); transition:all 0.15s; flex-shrink:0; }
  .week-arrow:hover { border-color:var(--accent); color:var(--accent); }
  .week-arrow.disabled { opacity:0.3; pointer-events:none; }

  .week-grid { background:white; border:1.5px solid var(--border); border-radius:12px; overflow:hidden; }
  .week-row { display:grid; grid-template-columns:repeat(7,1fr); }
  .week-header-row { background:var(--ink); }
  .week-header-cell { display:flex; flex-direction:column; align-items:center; padding:0.4rem 0.2rem 0.35rem; gap:1px; }
  .week-header-cell .hdr-day { font-size:0.68rem; opacity:0.6; letter-spacing:0.05em; text-transform:uppercase; color:white; }
  .week-header-cell .hdr-date { font-size:0.88rem; font-weight:700; color:white; }
  .week-header-cell.is-weekend .hdr-day { opacity:0.3; }
  .week-header-cell.is-weekend .hdr-date { color:rgba(255,255,255,0.4); }
  .day-cell { border-right:1px solid var(--border); border-bottom:1px solid var(--border); padding:0.35rem 0.3rem 0.3rem; position:relative; min-width:0; background:white; overflow:visible; }
  .week-row:last-child .day-cell { border-bottom:none; }
  .day-cell:last-child { border-right:none; }
  .day-cell.is-weekend { background:#fdfaf7; }
  .day-cell.is-empty { background:var(--cream); opacity:0.3; }
  .day-cell.is-wedding { background:var(--wedding-light); border-color:#d0aae8; }

  .slot-bars { display:flex; flex-direction:column; gap:2px; }
  .slot-bar-row { display:flex; align-items:center; gap:3px; font-size:0.57rem; color:var(--muted); white-space:nowrap; }
  .slot-bar-label { width:12px; flex-shrink:0; font-size:0.63rem; }
  .slot-bar-track { flex:1; height:6px; border-radius:3px; background:var(--cream); overflow:hidden; min-width:8px; }
  .slot-bar-fill { height:100%; border-radius:3px; background:var(--sage); transition:width 0.3s; }
  .slot-bar-fill.ok { background:var(--gold); }
  .slot-bar-fill.low { background:var(--accent); }
  .slot-count { font-size:0.58rem; color:var(--muted); min-width:16px; text-align:right; }

  .wedding-cell-inner { display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:0.5rem 0.2rem; gap:3px; min-height:80px; }
  .wedding-emoji { font-size:1.4rem; }
  .wedding-label { font-family:'Playfair Display',serif; font-size:0.72rem; font-weight:700; color:var(--wedding); letter-spacing:0.04em; text-transform:uppercase; line-height:1.2; }
  .wedding-date { font-size:0.62rem; color:var(--wedding); opacity:0.7; }

  .best-days { background:var(--sage-light); border:1.5px solid var(--sage); border-radius:10px; padding:0.9rem 1.1rem; margin-top:1.2rem; font-size:0.86rem; }
  .best-days h3 { font-weight:600; margin-bottom:0.4rem; color:#3a5c3f; }
  .best-days p { color:#4a6c4f; line-height:1.8; }
  .best-slot-tag { display:inline-flex; align-items:center; gap:3px; background:var(--sage); color:white; border-radius:5px; padding:0.1rem 0.5rem; font-size:0.78rem; font-weight:600; margin:0.1rem; }

  .tooltip-wrap { position:relative; overflow:visible; }
  .tooltip-content { display:none; position:absolute; bottom:calc(100% + 5px); left:50%; transform:translateX(-50%); background:var(--ink); color:white; border-radius:6px; padding:0.45rem 0.65rem; font-size:0.73rem; white-space:pre; z-index:300; pointer-events:none; line-height:1.6; min-width:145px; text-align:left; box-shadow:0 4px 16px rgba(0,0,0,0.28); }
  .tooltip-wrap:hover .tooltip-content { display:block; }

  .loading { text-align:center; padding:2rem; color:var(--muted); font-size:0.9rem; }

  @media(max-width:600px) { .page{padding:0.7rem;} .week-pill{padding:0.28rem 0.65rem;font-size:0.74rem;} }
</style>
</head>
<body>



<header>
  <h1>Rehearsal Availability</h1>
  <p>Organiser view â€” not shared with singers</p>
  <div class="organiser-badge">ğŸ”‘ Organiser Overview</div>
</header>

<div class="page">
  <div class="top-bar">
    <button class="refresh-btn" onclick="refresh()">â†» Refresh</button>
    <button class="refresh-btn" onclick="exportCSV()" style="border-color:var(--sage);color:var(--sage)">â¬‡ Export to CSV</button>
    <span class="last-updated" id="last-updated"></span>
  </div>

  <div class="overview-header">
    <h2>Singers who've responded</h2>
    <div class="singers-list" id="singers-list"></div>
  </div>

 <div class="legend">
    <span style="font-weight:600;color:var(--ink);margin-right:0.2rem">Bar fill = free singers:</span>
    <span class="legend-item"><span class="legend-swatch" style="background:#6b8f71"></span> All free</span>
    <span class="legend-item"><span class="legend-swatch" style="background:#d4a843"></span> Most free</span>
    <span class="legend-item"><span class="legend-swatch" style="background:#c9573a"></span> Many blocked</span>
  </div>

  <div id="overview-week-ui"><div class="loading">Loadingâ€¦</div></div>

  <div class="best-days">
    <h3>âœ¨ Best rehearsal slots</h3>
    <p id="best-days-text">Loadingâ€¦</p>
  </div>
</div>

<script type="module">
import { initializeApp }                     from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

// â”€â”€ PASTE YOUR FIREBASE CONFIG OBJECT HERE (same values as singer page) â”€â”€â”€â”€â”€â”€â”€
const firebaseConfig = {
  apiKey: "AIzaSyCerpfgRkMQggYcx2bWdrYJ1DlZ-C83kMU",
  authDomain: "rehearsal-calendar-adba7.firebaseapp.com",
  projectId: "rehearsal-calendar-adba7",
  storageBucket: "rehearsal-calendar-adba7.firebasestorage.app",
  messagingSenderId: "505359169564",
  appId: "1:505359169564:web:5d991b121c0d03a467c7d9"
};
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const app    = initializeApp(firebaseConfig);
const db     = getFirestore(app);
const DOCREF = doc(db, 'choir', 'availability');

const WEEKS = [
  { dates: range('2026-03-02','2026-03-08') },
  { dates: range('2026-03-09','2026-03-15') },
  { dates: range('2026-03-16','2026-03-22') },
  { dates: range('2026-03-23','2026-03-29') },
  { dates: range('2026-03-30','2026-04-05') },
];
const R_START='2026-03-02', R_END='2026-04-02', WEDDING='2026-04-03';
const SLOTS=['m','a','e'];
const SLABEL={m:'Morning',a:'Afternoon',e:'Evening'};
const SICON={m:'ğŸŒ…',a:'â˜€ï¸',e:'ğŸŒ™'};
const DSHORT=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
const MSHORT=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

let allData={}, overviewWeek=0;

function range(s,e){const a=[],[sy,sm,sd]=s.split('-').map(Number),[ey,em,ed]=e.split('-').map(Number);let d=new Date(Date.UTC(sy,sm-1,sd)),end=new Date(Date.UTC(ey,em-1,ed));while(d<=end){a.push(d.toISOString().slice(0,10));d.setUTCDate(d.getUTCDate()+1);}return a;}
function pd(iso){const[y,m,d]=iso.split('-').map(Number);return new Date(Date.UTC(y,m-1,d));}
function gd(d){return d.getUTCDate();} function gm(d){return d.getUTCMonth();} function gw(d){return d.getUTCDay();}
function inRange(iso){return iso>=R_START&&iso<=R_END;}
function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

async function load(){
  try{const s=await getDoc(DOCREF);allData=s.exists()?s.data():{};}catch(e){allData={};}
  const el=document.getElementById('last-updated');
  if(el)el.textContent='Last refreshed: '+new Date().toLocaleTimeString();
}

window.refresh=async function(){await load();renderAll();};

window.exportCSV=function(){
  const names=Object.keys(allData);
  if(!names.length){alert('No responses yet.');return;}

  // Collect all dates in range
  const allDates=[];
  WEEKS.forEach(w=>w.dates.forEach(iso=>{if(inRange(iso))allDates.push(iso);}));

  // Build header row: Name, Eircode, then one column per date+slot
  const headers=['Name','Eircode'];
  allDates.forEach(iso=>{
    const d=pd(iso),dow=gw(d),di=(dow+6)%7;
    const label=`${DSHORT[di]} ${gd(d)} ${MSHORT[gm(d)]}`;
    SLOTS.forEach(s=>headers.push(`${label} ${SLABEL[s]}`));
  });

  const rows=[headers];

  names.forEach(name=>{
    const data=allData[name]||{};
    const row=[name, data._eircode||''];
    allDates.forEach(iso=>{
      SLOTS.forEach(s=>{
        const key=`${iso}-${s}`;
        row.push(data[key]?'UNAVAILABLE':'free');
      });
    });
    rows.push(row);
  });

  // Also add a summary row showing free count per slot
  const summaryRow=['TOTAL FREE',''];
  allDates.forEach(iso=>{
    SLOTS.forEach(s=>{
      const key=`${iso}-${s}`;
      const free=names.filter(n=>!allData[n][key]).length;
      summaryRow.push(`${free}/${names.length}`);
    });
  });
  rows.push(summaryRow);

  // Convert to CSV string
  const csv=rows.map(row=>row.map(cell=>`"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');

  // Trigger download
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`rehearsal-availability-${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
};

function renderAll(){renderChips();renderOverviewWeek();renderBestSlots();}

function renderChips(){
  const cont=document.getElementById('singers-list');
  const names=Object.keys(allData);
  if(!names.length){cont.innerHTML='<span class="no-singers">No singers have responded yet.</span>';return;}
  cont.innerHTML=names.map(name=>{
    const ec=allData[name]._eircode;
    return `<div class="singer-chip"><span class="chip-dot"></span>${esc(name)}${ec?` <span style="color:var(--muted);font-size:0.75rem">ğŸ“ ${esc(ec)}</span>`:''}<span class="chip-remove" onclick="removeSinger(${JSON.stringify(name)})">&times;</span></div>`;
  }).join('');
}

window.removeSinger=async function(name){
  if(!confirm(`Remove ${name}'s responses?`))return;
  delete allData[name];
  await setDoc(DOCREF,allData);
  renderAll();
};

function buildNav(cur,onSel,cont){
  const nav=document.createElement('div');nav.className='week-nav';
  const L=document.createElement('div');L.className='week-arrow'+(cur===0?' disabled':'');L.textContent='â†';L.onclick=()=>onSel(cur-1);
  const pills=document.createElement('div');pills.className='week-pills';
  WEEKS.forEach((w,i)=>{
    const p=document.createElement('div');p.className='week-pill'+(i===cur?' active':'');
    const f=pd(w.dates[0]),l=pd(w.dates[w.dates.length-1]);
    p.textContent=`${gd(f)} ${MSHORT[gm(f)]}â€“${gd(l)} ${MSHORT[gm(l)]}`;
    p.onclick=()=>onSel(i);pills.appendChild(p);
  });
  const R=document.createElement('div');R.className='week-arrow'+(cur===WEEKS.length-1?' disabled':'');R.textContent='â†’';R.onclick=()=>onSel(cur+1);
  nav.appendChild(L);nav.appendChild(pills);nav.appendChild(R);cont.appendChild(nav);
}

function buildGrid(wi,cellFn){
  const wk=WEEKS[wi],wrap=document.createElement('div');wrap.className='week-grid';
  const hr=document.createElement('div');hr.className='week-row week-header-row';
  wk.dates.forEach(iso=>{
    const d=pd(iso),dow=gw(d),we=dow===0||dow===6,di=(dow+6)%7;
    const h=document.createElement('div');h.className='week-header-cell'+(we?' is-weekend':'');
    h.innerHTML=`<span class="hdr-day">${DSHORT[di]}</span><span class="hdr-date">${gd(d)} ${MSHORT[gm(d)]}</span>`;
    hr.appendChild(h);
  });
  wrap.appendChild(hr);
  const br=document.createElement('div');br.className='week-row';
  wk.dates.forEach(iso=>{
    const d=pd(iso),dow=gw(d),we=dow===0||dow===6,isW=iso===WEDDING,oor=!inRange(iso)&&!isW;
    const cell=document.createElement('div');
    cell.className='day-cell'+(we?' is-weekend':'')+(isW?' is-wedding':'')+(oor?' is-empty':'');
    cellFn(cell,iso,isW,oor);br.appendChild(cell);
  });
  wrap.appendChild(br);return wrap;
}

function renderOverviewWeek(){
  const cont=document.getElementById('overview-week-ui');cont.innerHTML='';
  const singers=Object.keys(allData),total=singers.length;
  buildNav(overviewWeek,i=>{overviewWeek=i;renderOverviewWeek();renderBestSlots();},cont);
  const grid=buildGrid(overviewWeek,(cell,iso,isW,oor)=>{
    if(isW){cell.innerHTML=`<div class="wedding-cell-inner"><span class="wedding-emoji">ğŸ’</span><span class="wedding-label">The Wedding!</span><span class="wedding-date">Thu 3 Apr</span></div>`;return;}
    if(oor)return;
    cell.classList.add('tooltip-wrap');
    const bars=document.createElement('div');bars.className='slot-bars';
    const d=pd(iso),dow=gw(d),di=(dow+6)%7;
    let tip=[`${DSHORT[di]} ${gd(d)} ${MSHORT[gm(d)]}`];
    SLOTS.forEach(s=>{
      const key=`${iso}-${s}`,blockedBy=singers.filter(n=>allData[n][key]);
      const free=total-blockedBy.length,pct=total>0?free/total:0;
     const fp=Math.round(pct*100);
      const fillColor=total===0?"#ddd8cc":pct>=0.85?"#6b8f71":pct>=0.6?"#d4a843":"#c9573a";
      const row=document.createElement('div');row.className='slot-bar-row';
      row.innerHTML=`<span class="slot-bar-label">${SICON[s]}</span><span class="slot-bar-track"><span class="slot-bar-fill" style="width:${fp}%;background:${fillColor}"></span></span>${total>0?`<span class="slot-count">${free}/${total}</span>`:''}`;
      bars.appendChild(row);
      if(total>0)tip.push(`${SICON[s]} ${SLABEL[s]}: ${free}/${total} free`+(blockedBy.length?`\n  âŒ ${blockedBy.join(', ')}`:'\n  âœ… All free'));
    });
    if(total===0)tip.push('No responses yet');
    cell.appendChild(bars);
    const tt=document.createElement('div');tt.className='tooltip-content';tt.textContent=tip.join('\n');cell.appendChild(tt);
  });
  cont.appendChild(grid);
}

function renderBestSlots(){
  const singers=Object.keys(allData),total=singers.length;
  const el=document.getElementById('best-days-text');
  if(!total){el.textContent='No responses yet.';return;}
  const scores=[];
  WEEKS.forEach(w=>w.dates.forEach(iso=>{
    if(!inRange(iso))return;
    const d=pd(iso),dow=gw(d),di=(dow+6)%7;
    SLOTS.forEach(s=>{
      const free=singers.filter(n=>!allData[n][`${iso}-${s}`]).length;
      scores.push({iso,s,di,d,free,total,pct:free/total});
    });
  }));
  const perfect=scores.filter(x=>x.free===x.total);
  const great=scores.filter(x=>x.pct>=0.8&&x.free<x.total);
  const fmt=x=>`<span class="best-slot-tag">${SICON[x.s]} ${DSHORT[x.di]} ${gd(x.d)} ${MSHORT[gm(x.d)]} Â· ${SLABEL[x.s]}</span>`;
  let html='';
  if(perfect.length)html+=`<strong>Everyone free:</strong><br>${perfect.map(fmt).join(' ')}`;
  if(great.length)html+=(html?'<br><br>':'')+`<strong>Almost everyone (â‰¥80%):</strong><br>${great.map(fmt).join(' ')}`;
  if(!html){const top=[...scores].sort((a,b)=>b.free-a.free).slice(0,6);html=`<strong>Best available slots:</strong><br>${top.map(x=>`${fmt(x)} <small>(${x.free}/${x.total})</small>`).join(' ')}`;}
  el.innerHTML=html;
}

await load();
renderAll();
</script>
</body>
</html>
